!function(){"use strict";let t=PRODUCT_VARIATION_CONFIG,e=t.selectors,i=t.debugMode,a=(t,e={},i=[])=>{let a=document.createElement(t);return Object.entries(e).forEach(([t,e])=>{"className"===t?a.className=e:"dataset"===t?Object.entries(e).forEach(([t,e])=>a.dataset[t]=e):t.startsWith("on")?a.addEventListener(t.slice(2).toLowerCase(),e):a[t]=e}),i.forEach(t=>a.appendChild(t)),a},n=(t,e,i="")=>{if(t.innerHTML="",i){let n=a("option",{value:"",textContent:`Pilih ${i}`,disabled:!0,selected:!0});t.appendChild(n)}e.forEach(e=>{t.appendChild(a("option",{value:e,textContent:e}))})},s=(t,e="error")=>{let i=a("div",{className:`toast ${e}`,textContent:t});document.body.appendChild(i),setTimeout(()=>i.remove(),3e3)};class r{constructor(t,e,i,a){this.attributes=t,this.onUpdate=e,this.onDelete=i,this.onComplete=a,this.fieldElements={},this.element=this.createRow()}createRow(){let t=a("div",{className:"variation-row"});this.attributes.forEach(e=>{let i=a("select",{name:e.name,dataset:{dependsOn:e.dependsOn||"",label:e.label},onChange:()=>this.handleSelectChange(i,e)});e.dependsOn?n(i,[],e.label):n(i,e.options,e.label),this.fieldElements[e.name]=i,t.appendChild(i)});let e=a("input",{type:"number",min:1,value:1,style:"width: 60px",onInput:t=>this.handleQuantityInput(t)}),i=a("button",{type:"button",textContent:"✕",onClick:()=>{this.element.remove(),this.onDelete(this)}});return t.append(e,i),this.qtyInput=e,t}handleSelectChange(t,e){let i=this.attributes.filter(t=>t.dependsOn===e.name);i.forEach(e=>{let i=this.fieldElements[e.name],a=e.conditionalOptions[t.value]||[];n(i,a,e.label),this.resetDependentChain(e.name)}),this.onUpdate(),this.isComplete()&&this.onComplete&&this.onComplete(this)}handleQuantityInput(t){let e=t.target,i=parseInt(e.value)||0,a=this.onUpdate(i);a&&!a.valid?(e.classList.add("error"),e.title=a.message,setTimeout(()=>{e.value=a.maxAllowed,e.classList.remove("error"),this.onUpdate(a.maxAllowed)},1500)):(e.classList.remove("error"),e.title="")}resetDependentChain(t){let e=this.attributes.filter(e=>e.dependsOn===t);e.forEach(t=>{let e=this.fieldElements[t.name];e&&(e.innerHTML="",this.resetDependentChain(t.name))})}getQuantity(){return parseInt(this.qtyInput.value)||0}getVariationText(t){let e=Object.values(this.fieldElements).filter(t=>t.value).map(t=>`${t.dataset.label}: ${t.value}`);return 0===e.length?"":`${t} --- ${e.join(" | ")} | Kuantiti: ${this.getQuantity()}`}isComplete(){return Object.values(this.fieldElements).every(t=>""!==t.value)}}class l{constructor(t,i){if(this.productRow=t,this.textareaField=i,this.variationRows=[],this.qtyInput=t.querySelector(e.qtyInput),this.productNameCell=t.querySelector(e.productName),this.productId=t.getAttribute("data-id"),this.productPosition=t.getAttribute("data-position"),!this.qtyInput||!this.productNameCell)return;this.attributes=this.getProductAttributes(),this.attributes&&this.attributes.length>0&&this.init()}getProductAttributes(){return t.productAttributes[this.productId]?t.productAttributes[this.productId]:t.defaultAttributes&&t.defaultAttributes.length>0?(i&&console.log(`Product ID ${this.productId} using default attributes`),t.defaultAttributes):(i&&console.log(`No attributes configured for product ID ${this.productId}`),null)}init(){this.addVariationDescription(),this.variationRow=document.createElement("tr"),this.variationRow.className="variation-row-container",this.variationRow.style.display="none";let t=document.createElement("td");t.setAttribute("colspan","3"),t.style.padding="0",this.container=a("div",{className:"variation-section"});let e=a("div",{className:"btn-container"});this.addBtn=a("button",{type:"button",className:"add-variation-btn",textContent:"Tambah Variasi",onClick:()=>this.addVariation()}),this.clearBtn=a("button",{type:"button",className:"add-variation-btn",textContent:"Padam Semua",style:"background: #e74c3c;",onClick:()=>this.clearAllVariations()}),this.qtyTracker=a("div",{className:"quantity-tracker"}),this.updateQuantityTracker();let n=a("div",{className:"top-container"});n.append(e,this.qtyTracker),e.append(this.addBtn,this.clearBtn),this.variationList=a("div"),this.container.append(n,this.variationList),t.appendChild(this.container),this.variationRow.appendChild(t),this.productRow.parentNode.insertBefore(this.variationRow,this.productRow.nextSibling);let s=()=>{i&&console.log(`Product ${this.productId}: Quantity changed to ${this.qtyInput.value}`),this.handleQtyChange()};$(this.qtyInput).on("select2:select",s),$(this.qtyInput).on("change",s),setTimeout(()=>{let t=parseInt(this.qtyInput.value)||0;t>0&&(i&&console.log(`Product ${this.productId}: Initial qty = ${t}`),this.handleQtyChange())},1e3)}addVariation(){let t=parseInt(this.qtyInput.value)||0,e=this.getTotalVariationQty();if(e>=t){s(`Jumlah melebihi kuantiti produk! Maksimum: ${t}`,"error");return}let i=new r(this.attributes,t=>this.validateAndUpdate(i,t),t=>this.deleteVariation(t),t=>this.handleVariationComplete(t));this.variationRows.push(i),this.variationList.appendChild(i.element),this.updateSummary()}handleVariationComplete(t){let e=this.findDuplicateVariation(t);if(e){let i=this.getVariationValues(t),a=Object.entries(i).map(([t,e])=>`${this.attributes.find(e=>e.name===t)?.label}: ${e}`).join(" | ");s(`Variasi yang sama digabungkan: ${a}`,"info"),this.mergeVariations(t,e)}}findDuplicateVariation(t){let e=this.getVariationValues(t);if(!e)return null;for(let i of this.variationRows){if(i===t)continue;let a=this.getVariationValues(i);if(a&&this.areVariationsEqual(e,a))return i}return null}getVariationValues(t){let e={},i=!0;for(let[a,n]of Object.entries(t.fieldElements)){if(!n.value){i=!1;break}e[a]=n.value}return i?e:null}areVariationsEqual(t,e){let i=Object.keys(t),a=Object.keys(e);if(i.length!==a.length)return!1;for(let n of i)if(t[n]!==e[n])return!1;return!0}mergeVariations(t,e){let i=t.getQuantity(),a=e.getQuantity(),n=i+a;e.qtyInput.value=n,t.element.remove();let s=this.variationRows.indexOf(t);s>-1&&this.variationRows.splice(s,1),e.element.classList.add("success"),setTimeout(()=>{e.element.classList.remove("success")},1e3),this.validateAndUpdate(e,n)}deleteVariation(t){let e=this.variationRows.indexOf(t);e>-1&&this.variationRows.splice(e,1),this.updateSummary(),i&&console.log(`Deleted variation. Remaining: ${this.variationRows.length}`)}validateAndUpdate(t,e){let i=parseInt(this.qtyInput.value)||0,a=this.variationRows.filter(e=>e!==t).reduce((t,e)=>t+e.getQuantity(),0),n=a+(e||t.getQuantity());if(n>i){let r=i-a,l=`Jumlah melebihi kuantiti produk! Maksimum: ${r}`;return s(l,"error"),this.updateSummary(),{valid:!1,message:l,maxAllowed:r}}return this.updateSummary(),{valid:!0}}getTotalVariationQty(){return this.variationRows.reduce((t,e)=>t+e.getQuantity(),0)}handleQtyChange(){let t=parseInt(this.qtyInput.value)||0;i&&console.log(`Product ${this.productId}: handleQtyChange called, qty=${t}`);let e=t>0?"table-row":"none";i&&console.log(`Product ${this.productId}: Setting display to ${e}`),this.variationRow.style.display=e,i&&(console.log(`Product ${this.productId}: Variation row display is now: ${this.variationRow.style.display}`),console.log(`Product ${this.productId}: Variation row in DOM: ${document.body.contains(this.variationRow)}`)),0===t&&this.clearAllVariations(),this.updateSummary()}clearAllVariations(){this.variationList.innerHTML="",this.variationRows=[],this.updateSummary()}getProductLabel(){let t=document.createElement("div");t.innerHTML=this.productNameCell.innerHTML;let e=t.querySelector(".variation-description");return e&&e.remove(),t.textContent.trim()}getProductIdentifier(){return{id:this.productId,position:this.productPosition,name:this.getProductLabel()}}addVariationDescription(){let e=t.productDescriptions&&t.productDescriptions[this.productId],i=e||this.generateVariationDescription();if(!i)return;let n=a("div",{className:"variation-description"});n.innerHTML=`${i}`,this.productNameCell.appendChild(n)}generateVariationDescription(){if(!this.attributes||0===this.attributes.length)return null;let t=this.attributes.map(t=>t.label);if(1===t.length)return`Variasi tersedia: ${t[0]}`;if(2===t.length)return`Variasi tersedia: ${t.join(" & ")}`;{let e=t.pop();return`Variasi tersedia: ${t.join(", ")} & ${e}`}}updateSummary(){this.updateQuantityTracker(),this.onSummaryUpdate&&this.onSummaryUpdate()}updateQuantityTracker(){if(!this.qtyTracker)return;let t=parseInt(this.qtyInput.value)||0,e=this.getTotalVariationQty(),i=t-e,a="#48bb78";0===i?a="#667eea":i<0&&(a="#e74c3c"),this.qtyTracker.innerHTML=`<span style="color: ${a};">Kuantiti: ${e}/${t}</span> <span style="color: #999;">(${i<0?"Lebihan":"Baki"}: ${Math.abs(i)})</span>`,this.qtyTracker.style.background=i<0?"#fff5f5":"#f0f0f0",i<0?this.qtyTracker.classList.add("over-limit"):this.qtyTracker.classList.remove("over-limit")}}class o{constructor(){this.productManagers=[],this.textareaField=document.querySelector(e.textarea),this.submitButton=document.querySelector("#submit-order"),this.warningContainer=null,this.textareaField&&(this.textareaField.readOnly=!0,this.textareaField.style.resize="vertical",this.textareaField.style.whiteSpace="nowrap"),this.submitButton&&(this.warningContainer=a("div",{className:"variation-warning",style:"display: none;"}),this.submitButton.parentElement.insertBefore(this.warningContainer,this.submitButton)),i&&console.log("Global Variation Manager initialized")}init(){let t=document.querySelectorAll(e.productRow);i&&console.log(`Found ${t.length} product rows`),t.forEach((t,e)=>{let a=t.getAttribute("data-id"),n=t.getAttribute("data-position");i&&console.log(`Processing product ${e}: ID=${a}, Position=${n}`);let s=new l(t,this.textareaField);s.qtyInput&&s.productNameCell&&s.attributes?(s.onSummaryUpdate=()=>this.updateGlobalSummary(),this.productManagers.push(s),i&&console.log(`✓ Product ${a} variation manager initialized with ${s.attributes.length} attributes`)):i&&console.log(`✗ Product ${a} skipped - Missing: qtyInput=${!!s.qtyInput}, productNameCell=${!!s.productNameCell}, attributes=${!!s.attributes}`)}),i&&console.log(`Initialized ${this.productManagers.length} product variation managers`)}updateGlobalSummary(){let t=[],e=[],i=[];this.productManagers.forEach(a=>{let n=a.getProductIdentifier(),s=n.name,r=parseInt(a.qtyInput.value)||0;if(r>0){let l=a.getTotalVariationQty(),o=a.variationRows.filter(t=>!t.isComplete()),d=l-r;d>0?i.push({name:s,selected:r,allocated:l,excess:d}):(0===l||l!==r||o.length>0)&&e.push({name:s,selected:r,allocated:l,remaining:r-l,hasIncompleteRows:o.length>0,incompleteCount:o.length}),a.variationRows.length>0&&a.variationRows.forEach(e=>{if(e.isComplete()){let i=Object.values(e.fieldElements).filter(t=>t.value).map(t=>`${t.dataset.label}: ${t.value}`);if(i.length>0){let a=`${s} --- ${i.join(" | ")} | Kuantiti: ${e.getQuantity()}`;t.push(`${a}`)}}})}});let a=t.map((t,e)=>`${e+1}. ${t}`);this.textareaField&&(this.textareaField.value=a.join("\n")),this.updateSubmitButtonState(e,i)}updateSubmitButtonState(t,e){if(this.submitButton){if(e.length>0){if(this.submitButton.disabled=!0,this.warningContainer){let a=e.map(t=>`<strong>${t.name}</strong>: Jumlah kuantiti variasi melebihi kuantiti produk!<br>(${t.allocated} unit variasi tetapi hanya ${t.selected} unit produk dipilih - Lebihan: ${t.excess} unit)<br><span style="font-size: 1.2rem; color: #d32f2f;">Sila kurangkan kuantiti variasi atau padamkan beberapa variasi</span>`);this.warningContainer.innerHTML=`<div style="font-weight: 600; margin-bottom: 5px;">Kuantiti Variasi Melebihi Had!</div><div style="font-size: 1.3rem;">${a.join("<br><br>")}</div>`,this.warningContainer.className="variation-warning exceeded",this.warningContainer.style.display=""}i&&console.log("Submit button DISABLED - Exceeded variations:",e)}else if(t.length>0){if(this.submitButton.disabled=!0,this.warningContainer){let n=t.map(t=>0===t.allocated?`<strong>${t.name}</strong>: ${t.selected} unit dipilih tetapi tiada variasi ditambah`:t.hasIncompleteRows?`<strong>${t.name}</strong>: ${t.incompleteCount} variasi belum lengkap (sila lengkapkan pilihan variasi)`:`<strong>${t.name}</strong>: ${t.allocated}/${t.selected} unit (kurang ${t.remaining})`);this.warningContainer.innerHTML=`<div style="font-weight: 600; margin-bottom: 3px;">Sila lengkapkan variasi produk:</div><div style="font-size: 1.3rem;">${n.join("<br>")}</div>`,this.warningContainer.className="variation-warning",this.warningContainer.style.display=""}i&&console.log("Submit button DISABLED - Incomplete variations:",t)}else{let s=this.productManagers.some(t=>parseInt(t.qtyInput.value)||!1);s?(this.submitButton.disabled=!1,this.warningContainer&&(this.warningContainer.style.display="none"),i&&console.log("Submit button ENABLED - All variations complete")):(this.submitButton.disabled=!1,this.warningContainer&&(this.warningContainer.style.display="none"))}}}}document.addEventListener("DOMContentLoaded",()=>{i&&console.log("DOM Content Loaded - Initializing Variation System");let t=new o;t.init(),setTimeout(()=>{t.updateGlobalSummary()},500)})}();